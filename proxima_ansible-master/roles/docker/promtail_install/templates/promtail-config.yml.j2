server:
  http_listen_address: 0.0.0.0
  http_listen_port: 9080

positions:
  filename: /tmp/positions.yaml

clients:
  - url: "{{ promtail.loki_path }}"

scrape_configs:
{% if promtail.containers is defined %}
{% raw %}
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/*log

  - job_name: containers
    entry_parser: raw

    static_configs:
      - targets:
          - localhost
        labels:
          job: containerlogs
          __path__: /var/lib/docker/containers/*/*log

    # --log-opt tag="{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
    pipeline_stages:
      - json:
          expressions:
            stream: stream
            attrs: attrs
            tag: attrs.tag

      - regex:
          expression: (?P<image_name>(?:[^|]*[^|])).(?P<container_name>(?:[^|]*[^|])).(?P<image_id>(?:[^|]*[^|])).(?P<container_id>(?:[^|]*[^|]))
          source: "tag"

      - labels:
          tag:
          stream:
          image_name:
          container_name:
          image_id:
          container_id:
{% endraw %}
{% endif %}

{% if promtail.configs is defined %}
{% for config in promtail.configs %}
  - job_name: {{ config.job_name }}
    pipeline_stages:
      - multiline:
          firstline: '^\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2}'
          max_wait_time: 3s
          max_lines: 255
    static_configs:
      - targets:
{% for target in config.targets %}
          - {{ target }}
{% endfor %}
        labels:
{% for key, value in config.labels.items() %}
          {{key}}: {{value}}
{% endfor %}
          __path__: {{ config.path }}
{% endfor %}
{% endif %}

{% if promtail.unit is defined %}
  - job_name: {{ promtail.unit.alias }}
    journal:
      json: false
      max_age: 12h
      path: /var/log/journal
      labels:
        job: {{ promtail.unit.alias }}
    relabel_configs:
      - action: drop
        source_labels: ["__journal__transport"]
        regex: "kernel"
      - source_labels: ["__journal__systemd_unit"]
        target_label: "unit"
{% endif %}