---
- name: Add Jetstack Helm Repository
  ansible.builtin.shell:
    cmd: helm repo add jetstack https://charts.jetstack.io

- name: Update Helm Repositories
  ansible.builtin.shell:
    cmd: helm repo update

- name: Run Helm Show Values Command
  ansible.builtin.shell:
    cmd: helm show values jetstack/cert-manager --version {{ version }} > /root/valuess.yml 
  args:
    executable: /bin/bash

- name: Open values.yml and modify installCRDs and prometheus settings
  ansible.builtin.replace:
    path: /root/valuess.yml
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  loop:
    - { regexp: 'installCRDs: false', replace: 'installCRDs: true' }
    - { regexp: '^prometheus:\n *enabled: true', replace: 'prometheus:\n  enabled: false' }

- name: Run Helm Upgrade Command
  ansible.builtin.shell:
    cmd: helm upgrade --install cert-manager jetstack/cert-manager --create-namespace cert-manager --version v1.13.2 --values /root/valuess.yml 
  args:
    executable: /bin/bash

- name: Create a file
  file:
    path: /root/issuer.yml
    state: touch

- name: Create Issuer YAML File
  ansible.builtin.blockinfile:
    path: /root/issuer.yml
    block: |
      apiVersion: cert-manager.io/v1
      kind: Issuer
      metadata:
        name: letsencrypt-prod
      spec:
        acme:
          server: https://acme-v02.api.letsencrypt.org/directory
          email: {{ email }}
          privateKeySecretRef:
            name: letsencrypt-prod
          solvers:
            - http01:
                ingress:
                  ingressClassName: nginx
    marker: "# {mark} ANSIBLE MANAGED BLOCK"

- name: Apply Issuer Configuration
  ansible.builtin.command:
    cmd: kubectl apply -f /root/issuer.yml
  args:
    executable: /bin/bash

